<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_1g7xbpg" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="4.12.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.15.0">
  <bpmn:process id="Process_1a49v7p" name="createCaseFromPipeline" isExecutable="true">
    <bpmn:serviceTask id="Activity_1qwn6qf" name="Открыть сессию" camunda:delegateExpression="${openSessionDelegate}">
      <bpmn:incoming>Flow_0ijxlkz</bpmn:incoming>
      <bpmn:outgoing>Flow_10kqd3k</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Activity_1jae6rb" name="Логирование процесса" camunda:delegateExpression="${loggerDelegate}">
      <bpmn:incoming>Flow_0hlfsn7</bpmn:incoming>
      <bpmn:outgoing>Flow_0ijxlkz</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:startEvent id="Event_0zdf9e0" name="Ответ от Pipeline в Kafka">
      <bpmn:outgoing>Flow_0hlfsn7</bpmn:outgoing>
      <bpmn:messageEventDefinition id="MessageEventDefinition_137u9fw" messageRef="Message_1w4kpx6" />
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_0ijxlkz" sourceRef="Activity_1jae6rb" targetRef="Activity_1qwn6qf" />
    <bpmn:sequenceFlow id="Flow_0hlfsn7" sourceRef="Event_0zdf9e0" targetRef="Activity_1jae6rb" />
    <bpmn:subProcess id="Activity_15er2ds">
      <bpmn:incoming>Flow_10kqd3k</bpmn:incoming>
      <bpmn:outgoing>Flow_163efhh</bpmn:outgoing>
      <bpmn:startEvent id="Event_19hntkt">
        <bpmn:outgoing>Flow_18bo35a</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:serviceTask id="Activity_1qptw1m" name="Направление JSON в топик Kafka" camunda:delegateExpression="${kafkaDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="key">${key}</camunda:inputParameter>
            <camunda:inputParameter name="payload">${caseJson}</camunda:inputParameter>
            <camunda:inputParameter name="messageId">message-case-out</camunda:inputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>Flow_1c87z3d</bpmn:incoming>
        <bpmn:outgoing>Flow_0z2wgzb</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:endEvent id="Event_1dxk5vn">
        <bpmn:incoming>Flow_0z2wgzb</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="Flow_0z2wgzb" sourceRef="Activity_1qptw1m" targetRef="Event_1dxk5vn" />
      <bpmn:serviceTask id="Activity_1gnbi7s" name="Сохранить&#10;Case" camunda:delegateExpression="${saveObjectDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="saveObject">${case}</camunda:inputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>Flow_1y9rsy0</bpmn:incoming>
        <bpmn:outgoing>Flow_1vbn7vr</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:scriptTask id="Activity_03j7n5b" name="Формирование case" scriptFormat="groovy" camunda:resultVariable="case">
        <bpmn:incoming>Flow_0yykbag</bpmn:incoming>
        <bpmn:outgoing>Flow_19fzael</bpmn:outgoing>
        <bpmn:script>import com.prime.db.rnkb.model.Case

Case caseData = new Case()

return caseData</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:scriptTask id="Activity_0us54of" name="Проверить парвила" scriptFormat="groovy" camunda:resultVariable="rulesResult">
        <bpmn:incoming>Flow_18bo35a</bpmn:incoming>
        <bpmn:outgoing>Flow_0shaxqn</bpmn:outgoing>
        <bpmn:script>import static org.camunda.spin.Spin.*
import static org.camunda.spin.DataFormats.*


def jsonStr = execution.getVariable("payload")
def jsonData = JSON(jsonStr)

def rules = jsonData.prop("rules").elements()
def paymentId = jsonData.prop("paymentId").stringValue()
def acceptedRules = []

rules.each{ rule -&gt; 
  acceptedRules.add(rule.stringValue())
}

if(acceptedRules.size() &gt; 0) {
  execution.setVariable("createCase", true)
  execution.setVariable("acceptedRules", acceptedRules)
}
execution.setVariable("paymentId", paymentId)

return jsonData.prop("rules") </bpmn:script>
      </bpmn:scriptTask>
      <bpmn:serviceTask id="Activity_0ssbjao" name="Сохранить&#10;Payment" camunda:delegateExpression="${saveObjectDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="saveObject">${payment}</camunda:inputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>Flow_19fzael</bpmn:incoming>
        <bpmn:outgoing>Flow_1y9rsy0</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="Flow_1y9rsy0" sourceRef="Activity_0ssbjao" targetRef="Activity_1gnbi7s" />
      <bpmn:sequenceFlow id="Flow_18bo35a" sourceRef="Event_19hntkt" targetRef="Activity_0us54of" />
      <bpmn:sequenceFlow id="Flow_19fzael" sourceRef="Activity_03j7n5b" targetRef="Activity_0ssbjao" />
      <bpmn:sequenceFlow id="Flow_1vbn7vr" sourceRef="Activity_1gnbi7s" targetRef="Activity_1ml27qt" />
      <bpmn:sequenceFlow id="Flow_1c87z3d" sourceRef="Activity_1ml27qt" targetRef="Activity_1qptw1m" />
      <bpmn:scriptTask id="Activity_1ml27qt" name="Формирование ответа" camunda:resultVariable="caseJson">
        <bpmn:incoming>Flow_1vbn7vr</bpmn:incoming>
        <bpmn:outgoing>Flow_1c87z3d</bpmn:outgoing>
        <bpmn:script>import com.prime.db.rnkb.model.Case

return "{}"</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:serviceTask id="Activity_0ze12rw" name="DBG" camunda:delegateExpression="${debugDelegate}">
        <bpmn:incoming>Flow_1g8v6rj</bpmn:incoming>
        <bpmn:incoming>Flow_0birzal</bpmn:incoming>
        <bpmn:outgoing>Flow_0yykbag</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="Flow_0shaxqn" sourceRef="Activity_0us54of" targetRef="Activity_06ngoq7" />
      <bpmn:exclusiveGateway id="Gateway_00dx1bx" name="Операция попала под правила?" default="Flow_18s1b05">
        <bpmn:incoming>Flow_1dk8c55</bpmn:incoming>
        <bpmn:outgoing>Flow_1b5ikfj</bpmn:outgoing>
        <bpmn:outgoing>Flow_18s1b05</bpmn:outgoing>
      </bpmn:exclusiveGateway>
      <bpmn:sequenceFlow id="Flow_1b5ikfj" sourceRef="Gateway_00dx1bx" targetRef="Activity_1xem02y">
        <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${execution.getVariable("createCase") != null}</bpmn:conditionExpression>
      </bpmn:sequenceFlow>
      <bpmn:scriptTask id="Activity_1xem02y" scriptFormat="groovy">
        <bpmn:incoming>Flow_1b5ikfj</bpmn:incoming>
        <bpmn:outgoing>Flow_1g8v6rj</bpmn:outgoing>
        <bpmn:script>import com.prime.db.mkb.model.Case


def case = new Case()
case.

def caseClient = execution.getVariable("caseClient") as CaseClient
def clientAccount = execution.getVariable("clientAccount") as ClientAccount

caseClient.accountnumber1 = clientAccount.accountnumber
caseClient.accountclosedate = clientAccount.closedate
caseClient.accountcurrency = clientAccount.currency
caseClient.accountlastupdatedate = clientAccount.lastupdatedate
caseClient.accountstartdate = clientAccount.startdate
if (clientAccount.status != null &amp;&amp; clientAccount.status?.code?.isNumber())
    caseClient.accountstatus = clientAccount.status?.code?.toInteger()

return caseClient</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:serviceTask id="Activity_06ngoq7" name="Select payment work" camunda:delegateExpression="${selectOneDelegate}">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:inputParameter name="outputVarName">payment</camunda:inputParameter>
            <camunda:inputParameter name="parameters">
              <camunda:map>
                <camunda:entry key="paymentId">${paymentId}</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="selectQuery">SELECT p FROM Payment p WHERE p.id = :paymentId</camunda:inputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>Flow_0shaxqn</bpmn:incoming>
        <bpmn:outgoing>Flow_1dk8c55</bpmn:outgoing>
      </bpmn:serviceTask>
      <bpmn:sequenceFlow id="Flow_1dk8c55" sourceRef="Activity_06ngoq7" targetRef="Gateway_00dx1bx" />
      <bpmn:sequenceFlow id="Flow_18s1b05" sourceRef="Gateway_00dx1bx" targetRef="Activity_1fgghev" />
      <bpmn:scriptTask id="Activity_1fgghev" name="Проставить статус payment" scriptFormat="groovy">
        <bpmn:incoming>Flow_18s1b05</bpmn:incoming>
        <bpmn:outgoing>Flow_0birzal</bpmn:outgoing>
        <bpmn:script>import com.prime.db.rnkb.model.Payment
import com.prime.db.rnkb.model.BaseDictionary

BaseDictionary getStatus(String code) {
   baseDictRepo.getByBaseDictionaryTypeCodeAndCode(45, code);
}

Payment payment = execution.getVariable("payment")
payment.paymentSourceStatus = getStatus("10")

execution.setVariable("payment", payment)</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:sequenceFlow id="Flow_1g8v6rj" sourceRef="Activity_1xem02y" targetRef="Activity_0ze12rw" />
      <bpmn:sequenceFlow id="Flow_0birzal" sourceRef="Activity_1fgghev" targetRef="Activity_0ze12rw" />
      <bpmn:sequenceFlow id="Flow_0yykbag" sourceRef="Activity_0ze12rw" targetRef="Activity_03j7n5b" />
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="Flow_10kqd3k" sourceRef="Activity_1qwn6qf" targetRef="Activity_15er2ds" />
    <bpmn:endEvent id="Event_098yyfy">
      <bpmn:incoming>Flow_13tvrx3</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:serviceTask id="Activity_131dz13" name="Закрыть сессию" camunda:delegateExpression="${closeSessionDelegate}">
      <bpmn:incoming>Flow_163efhh</bpmn:incoming>
      <bpmn:outgoing>Flow_13tvrx3</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_13tvrx3" sourceRef="Activity_131dz13" targetRef="Event_098yyfy" />
    <bpmn:sequenceFlow id="Flow_163efhh" sourceRef="Activity_15er2ds" targetRef="Activity_131dz13" />
    <bpmn:textAnnotation id="TextAnnotation_049rt3r">
      <bpmn:text>PAYMENT.EXID
Массив кодов сработавших сценариев  из справочника 272 Справочник UID (правила СО)</bpmn:text>
    </bpmn:textAnnotation>
    <bpmn:association id="Association_0fu882p" sourceRef="TextAnnotation_049rt3r" targetRef="Event_0zdf9e0" />
  </bpmn:process>
  <bpmn:message id="Message_1ld6d8j" name="message-pipeline" />
  <bpmn:message id="Message_1w4kpx6" name="message-pipeline" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1a49v7p">
      <bpmndi:BPMNEdge id="Flow_163efhh_di" bpmnElement="Flow_163efhh">
        <di:waypoint x="1790" y="260" />
        <di:waypoint x="1870" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_13tvrx3_di" bpmnElement="Flow_13tvrx3">
        <di:waypoint x="1970" y="260" />
        <di:waypoint x="2072" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_10kqd3k_di" bpmnElement="Flow_10kqd3k">
        <di:waypoint x="590" y="254" />
        <di:waypoint x="680" y="254" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0hlfsn7_di" bpmnElement="Flow_0hlfsn7">
        <di:waypoint x="310" y="254" />
        <di:waypoint x="352" y="254" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ijxlkz_di" bpmnElement="Flow_0ijxlkz">
        <di:waypoint x="452" y="254" />
        <di:waypoint x="490" y="254" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Activity_1qwn6qf_di" bpmnElement="Activity_1qwn6qf">
        <dc:Bounds x="490" y="214" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1jae6rb_di" bpmnElement="Activity_1jae6rb">
        <dc:Bounds x="352" y="214" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0zdf9e0_di" bpmnElement="Event_0zdf9e0">
        <dc:Bounds x="274" y="236" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="249" y="279" width="87" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_15er2ds_di" bpmnElement="Activity_15er2ds" isExpanded="true">
        <dc:Bounds x="680" y="168" width="1110" height="522" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_0shaxqn_di" bpmnElement="Flow_0shaxqn">
        <di:waypoint x="840" y="300" />
        <di:waypoint x="840" y="335" />
        <di:waypoint x="790" y="335" />
        <di:waypoint x="790" y="380" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1c87z3d_di" bpmnElement="Flow_1c87z3d">
        <di:waypoint x="1500" y="260" />
        <di:waypoint x="1560" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1vbn7vr_di" bpmnElement="Flow_1vbn7vr">
        <di:waypoint x="1350" y="260" />
        <di:waypoint x="1400" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_19fzael_di" bpmnElement="Flow_19fzael">
        <di:waypoint x="1050" y="260" />
        <di:waypoint x="1100" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18bo35a_di" bpmnElement="Flow_18bo35a">
        <di:waypoint x="756" y="260" />
        <di:waypoint x="800" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1y9rsy0_di" bpmnElement="Flow_1y9rsy0">
        <di:waypoint x="1200" y="260" />
        <di:waypoint x="1250" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0z2wgzb_di" bpmnElement="Flow_0z2wgzb">
        <di:waypoint x="1660" y="260" />
        <di:waypoint x="1732" y="260" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1b5ikfj_di" bpmnElement="Flow_1b5ikfj">
        <di:waypoint x="1115" y="410" />
        <di:waypoint x="1190" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1dk8c55_di" bpmnElement="Flow_1dk8c55">
        <di:waypoint x="890" y="410" />
        <di:waypoint x="1065" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_18s1b05_di" bpmnElement="Flow_18s1b05">
        <di:waypoint x="1090" y="435" />
        <di:waypoint x="1090" y="510" />
        <di:waypoint x="1190" y="510" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1g8v6rj_di" bpmnElement="Flow_1g8v6rj">
        <di:waypoint x="1290" y="410" />
        <di:waypoint x="1360" y="410" />
        <di:waypoint x="1360" y="450" />
        <di:waypoint x="1430" y="450" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0birzal_di" bpmnElement="Flow_0birzal">
        <di:waypoint x="1290" y="510" />
        <di:waypoint x="1360" y="510" />
        <di:waypoint x="1360" y="450" />
        <di:waypoint x="1430" y="450" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0yykbag_di" bpmnElement="Flow_0yykbag">
        <di:waypoint x="1480" y="410" />
        <di:waypoint x="1480" y="350" />
        <di:waypoint x="1240" y="350" />
        <di:waypoint x="1240" y="290" />
        <di:waypoint x="1050" y="290" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Event_19hntkt_di" bpmnElement="Event_19hntkt">
        <dc:Bounds x="720" y="242" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ij9x6j_di" bpmnElement="Activity_1qptw1m">
        <dc:Bounds x="1560" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1dxk5vn_di" bpmnElement="Event_1dxk5vn">
        <dc:Bounds x="1732" y="242" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1gnbi7s_di" bpmnElement="Activity_1gnbi7s">
        <dc:Bounds x="1250" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_02oxw06_di" bpmnElement="Activity_03j7n5b">
        <dc:Bounds x="950" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0us54of_di" bpmnElement="Activity_0us54of">
        <dc:Bounds x="800" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ssbjao_di" bpmnElement="Activity_0ssbjao">
        <dc:Bounds x="1100" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0lmu2sf_di" bpmnElement="Activity_1ml27qt">
        <dc:Bounds x="1400" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_00dx1bx_di" bpmnElement="Gateway_00dx1bx" isMarkerVisible="true">
        <dc:Bounds x="1065" y="385" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1061" y="330" width="59" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_06ngoq7_di" bpmnElement="Activity_06ngoq7">
        <dc:Bounds x="790" y="370" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1bgq5uh_di" bpmnElement="Activity_1xem02y">
        <dc:Bounds x="1190" y="370" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0qtjuyj_di" bpmnElement="Activity_1fgghev">
        <dc:Bounds x="1190" y="470" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ze12rw_di" bpmnElement="Activity_0ze12rw">
        <dc:Bounds x="1430" y="410" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_098yyfy_di" bpmnElement="Event_098yyfy">
        <dc:Bounds x="2072" y="242" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_131dz13_di" bpmnElement="Activity_131dz13">
        <dc:Bounds x="1870" y="220" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="TextAnnotation_049rt3r_di" bpmnElement="TextAnnotation_049rt3r">
        <dc:Bounds x="130" y="84" width="323" height="68" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Association_0fu882p_di" bpmnElement="Association_0fu882p">
        <di:waypoint x="292" y="152" />
        <di:waypoint x="292" y="236" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
